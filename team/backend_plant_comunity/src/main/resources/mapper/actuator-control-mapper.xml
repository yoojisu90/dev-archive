<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.backend_plant_comunity.environment.mapper.ActuatorControlMapper">

    <resultMap id="actuatorControl" type="com.green.backend_plant_comunity.environment.dto.ActuatorControlDTO">
        <id     column="CONTROL_ID"     property="controlId"/>
        <result column="ACT_NAME"       property="actName"/>
        <result column="RASP_NUM"       property="raspNum"/>
        <result column="COMMAND"        property="command"/>
        <result column="MODE"           property="mode"/>
        <result column="CREATED_TIME"   property="createdTime"/>
        <result column="PROCESSED"      property="processed"/>
    </resultMap>

    <resultMap id="actuatorLog" type="com.green.backend_plant_comunity.environment.dto.ActuatorLogDTO">
        <id     column="LOG_ID"         property="logId"/>
        <result column="ACT_NAME"       property="actName"/>
        <result column="RASP_NUM"       property="raspNum"/>
        <result column="STATE"          property="state"/>
        <result column="MODE"           property="mode"/>
        <result column="EVENT_TIME"     property="eventTime"/>
    </resultMap>

    <insert id="insertControlCommand" parameterType="com.green.backend_plant_comunity.environment.dto.ActuatorControlDTO">
        INSERT INTO ACTUATOR_CONTROL (
            ACT_NAME,
            RASP_NUM,
            COMMAND,
            MODE,
            CREATED_TIME,
            PROCESSED
        ) VALUES (
            #{actName},
            #{raspNum},
            #{command},
            #{mode},
            NOW(),
            FALSE
        )
    </insert>

    <select id="getLatestStatus" resultMap="actuatorLog">
        SELECT
            l.LOG_ID,
            l.ACT_NAME,
            l.RASP_NUM,
            l.STATE,
            l.MODE,
            l.EVENT_TIME
        FROM ACTUATOR_LOG l
        WHERE l.RASP_NUM = #{raspNum}
          AND l.ACT_NAME = #{actName}
        ORDER BY l.EVENT_TIME DESC
        LIMIT 1
    </select>

    <select id="getActuatorLogs" resultMap="actuatorLog">
        <![CDATA[
        SELECT
            LOG_ID,
            ACT_NAME,
            RASP_NUM,
            STATE,
            MODE,
            EVENT_TIME
        FROM ACTUATOR_LOG
        WHERE RASP_NUM = #{raspNum}
    ]]>
        <if test="actName != null and actName != ''">
            AND ACT_NAME = #{actName}
        </if>
        ORDER BY EVENT_TIME DESC
        <if test="limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <select id="getControlHistory" resultMap="actuatorControl">
        SELECT
            CONTROL_ID,
            ACT_NAME,
            RASP_NUM,
            COMMAND,
            MODE,
            CREATED_TIME,
            PROCESSED
        FROM ACTUATOR_CONTROL
        WHERE RASP_NUM = #{raspNum}
        <if test="actName != null and actName != ''">
            AND ACT_NAME = #{actName}
        </if>
        ORDER BY CREATED_TIME DESC
        LIMIT 100
    </select>

    <delete id="cleanupOldCommands">
        <![CDATA[
        DELETE FROM ACTUATOR_CONTROL
        WHERE PROCESSED = TRUE
          AND CREATED_TIME < DATE_SUB(NOW(), INTERVAL 1 HOUR)
    ]]>
    </delete>

</mapper>
