<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.backend_plant_comunity.member.mapper.MemberMapper">
    <resultMap id="member" type="com.green.backend_plant_comunity.member.dto.MemberDTO">
        <id     column="MEM_ID"             property="memId" />
        <result column="MEM_PW"             property="memPw" />
        <result column="MEM_NAME"           property="memName" />
        <result column="MEM_ADDR"           property="memAddr" />
        <result column="MEM_DETAIL_ADDR"    property="memDetailAddr" />
        <result column="MEM_TELL"           property="memTell" />
        <result column="MEM_EMAIL"          property="memEmail" />
        <result column="MEM_GRADE"          property="memGrade" />
        <result column="JOIN_DATE"          property="joinDate" />
        <result column="MEM_BUSINESS_NUM"   property="memBusinessNum" />
        <result column="MEM_BUSINESS_NAME"  property="memBusinessName" />
        <result column="MEM_STATUS"         property="memStatus" />
    </resultMap>

    <resultMap id="memberProfile" type="com.green.backend_plant_comunity.member.dto.MemberProfileDTO">
        <id     column="PROFILE_NO"          property="profileNo" />
        <result column="MEM_ID"              property="memId" />
        <result column="PROFILE_IMAGE_URL"   property="profileImageUrl" />
        <result column="PROFILE_IMAGE_NAME"  property="profileImageName" />
        <result column="UPLOAD_DATE"         property="uploadDate" />
    </resultMap>

    <!--회원가입 버튼 누르면 실행할 쿼리-->
    <insert id="joinMember">
        INSERT INTO member(
            MEM_ID
            , MEM_PW
            , MEM_NAME
        <if test='memAddr != ""'>
            , MEM_ADDR
        </if>
        <if test='memDetailAddr != ""'>
            , MEM_DETAIL_ADDR
        </if>
            , MEM_TELL
        <if test='memEmail != ""'>
            , MEM_EMAIL
        </if>
            , MEM_GRADE
        <if test='memBusinessNum != ""'>
            , MEM_BUSINESS_NUM
        </if>
        <if test='memBusinessName != ""'>
            , MEM_BUSINESS_NAME
        </if>
            , MEM_STATUS
        ) VALUES (
            #{memId}
            , #{memPw}
            , #{memName}
        <if test='memAddr != ""'>
            , #{memAddr}
        </if>
        <if test='memDetailAddr != ""'>
            , #{memDetailAddr}
        </if>
        , #{memTell}
        <if test='memEmail != ""'>
            , #{memEmail}
        </if>
            , #{memGrade}
        <if test='memBusinessNum != ""'>
            , #{memBusinessNum}
        </if>
        <if test='memBusinessName != ""'>
            , #{memBusinessName}
        </if>
            , COALESCE(#{memStatus}, 'ACTIVE')
        );
    </insert>

    <!--회원아이디 중복검사 (활성 회원만)-->
    <select id="checkId" resultType="int">
        SELECT COUNT(*)
        FROM member
        WHERE MEM_ID = #{memId}
        AND MEM_STATUS = 'ACTIVE'
    </select>

    <!--회원연락처 중복검사 (활성 회원만)-->
    <select id="checkTell" resultType="int">
        SELECT COUNT(*)
        FROM member
        WHERE MEM_TELL = #{memTell}
        AND MEM_STATUS = 'ACTIVE'
    </select>
    
    <!--사업자번호 중복검사 (활성 회원만)-->
    <select id="checkBusinessNum" resultType="int">
        SELECT COUNT(*)
        FROM member
        WHERE MEM_BUSINESS_NUM = #{memBusinessNum}
        AND MEM_STATUS = 'ACTIVE'
    </select>
    
    <!--로그인시 아이디, 비밀번호 일치 조회 (활성 회원만)-->
    <select id="login" resultMap="member">
        SELECT
            MEM_ID
            , MEM_NAME
            , MEM_GRADE
            , MEM_STATUS
            , MEM_ADDR
        FROM MEMBER
        WHERE MEM_ID = #{memId}
        AND MEM_PW = #{memPw}
        AND MEM_STATUS = 'ACTIVE'
    </select>

    <!--아이디 찾기 (활성 회원만)-->
    <select id="findId" resultMap="member">
        SELECT MEM_ID
        FROM member
        WHERE MEM_NAME = #{memName}
        AND MEM_TELL = #{memTell}
        AND MEM_STATUS = 'ACTIVE'
    </select>
    
    <!--비밀번호 찾기 (활성 회원만)-->
    <select id="findPw" resultMap="member">
        SELECT
            MEM_ID,
            MEM_PW
        FROM member
        WHERE MEM_NAME = #{memName}
        AND MEM_TELL = #{memTell}
        AND MEM_ID = #{memId}
        AND MEM_STATUS = 'ACTIVE'
    </select>

    <!--my page 화면 에서 회원정보 조회-->
    <select id="getMemberDetail" resultMap="member">
        SELECT
            MEM_ID
            , MEM_PW
            , MEM_NAME
            , MEM_ADDR
            , MEM_DETAIL_ADDR
            , MEM_TELL
            , MEM_EMAIL
            , MEM_GRADE
            , MEM_BUSINESS_NUM
            , MEM_BUSINESS_NAME
            , MEM_STATUS
        FROM MEMBER
        WHERE MEM_ID = #{memId}
        AND MEM_STATUS = 'ACTIVE'
    </select>

    <!--회원정보 수정-->
    <update id="updateMember">
        UPDATE MEMBER
        SET
            MEM_PW = #{memPw},
            MEM_ADDR = #{memAddr},
            MEM_DETAIL_ADDR = #{memDetailAddr},
            MEM_TELL = #{memTell},
            MEM_EMAIL = #{memEmail},
            MEM_BUSINESS_NUM = #{memBusinessNum},
            MEM_BUSINESS_NAME = #{memBusinessName}
        WHERE MEM_ID = #{memId}
    </update>

    <!-- [관리자] 전체 활성 회원 목록 조회 -->
    <select id="selAllMembers" resultMap="member">
        SELECT
            MEM_ID,
            MEM_NAME,
            MEM_TELL,
            MEM_EMAIL,
            MEM_ADDR,
            MEM_BUSINESS_NUM,
            JOIN_DATE,
            MEM_STATUS,
            MEM_GRADE
        FROM MEMBER
        WHERE MEM_STATUS = 'ACTIVE'
        ORDER BY JOIN_DATE DESC
    </select>

    <!-- [관리자] 삭제/탈퇴된 회원 목록 조회 -->
    <select id="selDeletedMembers" resultMap="member">
        SELECT
            MEM_ID,
            MEM_NAME,
            MEM_TELL,
            MEM_EMAIL,
            MEM_ADDR,
            MEM_BUSINESS_NUM,
            JOIN_DATE,
            MEM_STATUS,
            MEM_GRADE
        FROM MEMBER
        WHERE MEM_STATUS IN ('DELETED', 'WITHDRAWN')
        ORDER BY JOIN_DATE DESC
    </select>

    <!-- 회원 검색 (쪽지 보낼 때) -->
    <select id="searchMembers" resultMap="member">
        SELECT
            MEM_ID,
            MEM_NAME,
            MEM_EMAIL
        FROM MEMBER
        WHERE (MEM_ID LIKE CONCAT('%', #{keyword}, '%')
           OR MEM_NAME LIKE CONCAT('%', #{keyword}, '%'))
        AND MEM_STATUS = 'ACTIVE'
        ORDER BY MEM_NAME
        LIMIT 10
    </select>

    <!-- [공통] 회원 상태 확인 -->
    <select id="getMemberStatus" resultType="String">
        SELECT MEM_STATUS
        FROM MEMBER
        WHERE MEM_ID = #{memId}
    </select>

    <!-- [관리자] 회원 상태 변경 (논리적 삭제) -->
    <update id="updateMemberStatus">
        UPDATE MEMBER 
        SET MEM_STATUS = #{status}
        WHERE MEM_ID = #{memId}
    </update>

    <!-- [관리자] 회원 복구 -->
    <update id="restoreMember">
        UPDATE MEMBER 
        SET MEM_STATUS = 'ACTIVE'
        WHERE MEM_ID = #{memId}
        AND MEM_STATUS IN ('DELETED', 'WITHDRAWN')
    </update>

    <!-- [일반회원] 회원 탈퇴 -->
    <update id="withdrawMember">
        UPDATE MEMBER
        SET MEM_STATUS = 'WITHDRAWN'
        WHERE MEM_ID = #{memId}
        AND MEM_STATUS = 'ACTIVE'
    </update>

    <!-- 프로필 이미지 등록 -->
    <insert id="insertProfile">
        INSERT INTO member_profile (
            MEM_ID,
            PROFILE_IMAGE_URL,
            PROFILE_IMAGE_NAME
        ) VALUES (
            #{memId},
            #{profileImageUrl},
            #{profileImageName}
        )
    </insert>

    <!-- 프로필 이미지 수정 -->
    <update id="updateProfile">
        UPDATE member_profile
        SET PROFILE_IMAGE_URL = #{profileImageUrl},
            PROFILE_IMAGE_NAME = #{profileImageName},
            UPLOAD_DATE = CURRENT_TIMESTAMP
        WHERE MEM_ID = #{memId}
    </update>

    <!-- 회원의 프로필 이미지 조회 -->
    <select id="getProfileByMemId" resultMap="memberProfile">
        SELECT
            PROFILE_NO,
            MEM_ID,
            PROFILE_IMAGE_URL,
            PROFILE_IMAGE_NAME,
            UPLOAD_DATE
        FROM
            member_profile
        WHERE
            MEM_ID = #{memId}
        ORDER BY UPLOAD_DATE DESC
        LIMIT 1
    </select>

    <!-- 프로필 이미지 삭제 -->
    <delete id="deleteProfile">
        DELETE FROM member_profile
        WHERE MEM_ID = #{memId}
    </delete>

</mapper>
