# 📅 캘린더 시스템 완전 정리

> 식물 농장 앱의 일정 관리 및 일기 작성 시스템에 대한 완전한 가이드

---

## 📋 목차

1. [시스템 개요](#-시스템-개요)
2. [아키텍처](#-아키텍처)
3. [주요 기능](#-주요-기능)
4. [컴포넌트 분석](#-컴포넌트-분석)
5. [API 서비스](#-api-서비스)
6. [데이터 흐름](#-데이터-흐름)
7. [작업 히스토리](#-작업-히스토리)
8. [트러블슈팅](#-트러블슈팅)
9. [향후 개선사항](#-향후-개선사항)

---

## 🎯 시스템 개요

### 기능 요약
- **물주기 일정 관리**: 식물별 물주기 일정 등록, 주기적 반복 설정
- **농사 일기 작성**: 날짜별 일기 작성, 날씨 기록
- **캘린더 시각화**: 월별 캘린더 뷰, 일정 점 표시
- **공휴일 표시**: 한국 공휴일 자동 표시 및 강조
- **삭제 기능**: 일정 및 일기 삭제 (확인 알림 포함)

### 주요 특징
| 특징 | 설명 | 아이콘 |
|------|------|--------|
| **물주기 일정** | 식물별 반복 일정 설정 | 💧 |
| **농사 일기** | 날짜별 일기 및 날씨 기록 | 📝 |
| **공휴일 표시** | 한국 공휴일 자동 마킹 | 🎉 |
| **시각적 표시** | 날짜별 점(dot) 색상 구분 | 🔵🟡 |
| **간편 삭제** | 원터치 삭제 (확인 대화상자) | 🗑️ |

### 사용 라이브러리
```json
{
  "react-native-calendars": "^1.1306.0",  // 캘린더 UI
  "date-holidays": "^3.23.12"              // 공휴일 데이터
}
```

---

## 🏗 아키텍처

### 시스템 구성도
```
┌─────────────────────┐
│   Calendar.jsx      │
│  (캘린더 메인 화면)  │
│                     │
│  - 캘린더 렌더링     │
│  - 일정 표시         │
│  - 모달 관리         │
│  - 이벤트 핸들러     │
└──────┬──────────────┘
       │
       │ import
       │
       ▼
┌─────────────────────┐
│ calendarService.js  │
│   (API 통신 레이어)  │
│                     │
│  - 물주기 CRUD      │
│  - 일기 CRUD        │
│  - 에러 처리        │
└──────┬──────────────┘
       │
       │ HTTP
       │
       ▼
┌─────────────────────┐       ┌──────────────┐
│  Spring Boot API    │◀─────▶│   MariaDB    │
│  192.168.30.107     │       │              │
│                     │       │ - watering   │
│  - /watering/*      │       │ - diary      │
│  - /diaries/*       │       │ - member     │
└─────────────────────┘       └──────────────┘
```

### 데이터베이스 스키마
```sql
-- 물주기 일정 테이블
CREATE TABLE watering (
  WATERING_ID INT PRIMARY KEY AUTO_INCREMENT,
  MEM_ID VARCHAR(20) NOT NULL,
  PLANT_NAME VARCHAR(50) NOT NULL,
  WATERING_DATE DATE NOT NULL,
  CYCLE_DAY INT NOT NULL,
  CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (MEM_ID) REFERENCES member(MEM_ID)
);

-- 일기 테이블
CREATE TABLE diary (
  DIARY_ID INT PRIMARY KEY AUTO_INCREMENT,
  MEM_ID VARCHAR(20) NOT NULL,
  DIARY_TITLE VARCHAR(100) NOT NULL,
  DIARY_CONTENT TEXT,
  DIARY_DATE DATE NOT NULL,
  WEATHER VARCHAR(20),
  CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (MEM_ID) REFERENCES member(MEM_ID)
);
```

---

## ⚡ 주요 기능

### 1. 물주기 일정 등록
**사용자 시나리오**:
1. 캘린더에서 날짜 선택
2. "💧 물주기" 버튼 클릭
3. 식물 이름, 주기(일), 횟수 입력
4. 자동으로 주기별 일정 생성

**예시**:
```
식물 이름: 토마토
주기: 3일
횟수: 10회
시작일: 2025-10-29

→ 생성되는 일정:
  2025-10-29 (1차)
  2025-11-01 (2차, +3일)
  2025-11-04 (3차, +3일)
  ...
  2025-11-26 (10차)
```

**코드 흐름**:
```javascript
// 1. 사용자 입력
const wateringData = {
  plantName: '토마토',
  cycle: '3',
  count: '10'
};

// 2. 날짜 계산 및 반복 등록
for (let i = 0; i < count; i++) {
  const eventDate = new Date(startDate);
  eventDate.setDate(startDate.getDate() + i * cycle);
  const dateString = eventDate.toISOString().split('T')[0];
  
  await apiAddWatering(memId, {
    plantName: wateringData.plantName,
    date: dateString,
    cycle: cycle,
  });
}

// 3. 캘린더 새로고침
await loadWateringSchedules();
```

---

### 2. 농사 일기 작성
**사용자 시나리오**:
1. 캘린더에서 날짜 선택
2. "📝 일기쓰기" 버튼 클릭
3. 제목, 내용, 날씨 선택 입력
4. 일기 저장

**날씨 옵션**:
- ☀️ 맑음
- ☁️ 흐림
- 🌧️ 비
- ⛈️ 폭우
- ❄️ 눈

**코드 흐름**:
```javascript
// 1. 사용자 입력
const diaryData = {
  title: '토마토 첫 수확',
  content: '오늘 드디어 첫 토마토를 수확했다. 정말 뿌듯하다!',
  weather: '맑음',
  date: '2025-10-29'
};

// 2. API 호출
await apiAddDiary(memId, {
  title: diaryData.title,
  content: diaryData.content,
  weather: diaryData.weather,
  date: selectedDate,
});

// 3. 캘린더 새로고침
await loadDiaries();
```

---

### 3. 공휴일 자동 표시
**라이브러리**: `date-holidays`

**기능**:
- 한국 공휴일 자동 로드 (신정, 설날, 추석, 어린이날 등)
- 공휴일 날짜는 빨간색 배경 + 빨간색 텍스트
- 공휴일 점(dot) 표시

**코드**:
```javascript
import HolidaysLib from 'date-holidays';
const Holidays = HolidaysLib.default ?? HolidaysLib;

const loadHolidays = () => {
  try {
    const hd = new Holidays('KR'); // 한국
    const currentYear = new Date().getFullYear();
    const list = hd.getHolidays(currentYear);
    
    const holidayMarks = {};
    list.forEach((holiday) => {
      const d = new Date(holiday.date);
      const dateString = d.toISOString().slice(0, 10);
      
      holidayMarks[dateString] = {
        marked: true,
        dotColor: '#FF6B6B',
        customStyles: {
          container: { backgroundColor: '#FF6B6B20' },
          text: { color: '#FF6B6B', fontWeight: 'bold' },
        },
      };
    });
    
    setMarkedDates((prev) => ({ ...prev, ...holidayMarks }));
  } catch (e) {
    console.warn('공휴일 로드 실패:', e);
  }
};
```

**지원 공휴일 예시**:
```
📅 2025년 공휴일
- 1월 1일: 신정
- 1월 28-30일: 설날 연휴
- 3월 1일: 삼일절
- 5월 5일: 어린이날
- 6월 6일: 현충일
- 8월 15일: 광복절
- 10월 3일: 개천절
- 10월 6-8일: 추석 연휴
- 10월 9일: 한글날
- 12월 25일: 크리스마스
```

---

### 4. 삭제 기능
**특징**:
- 확인 대화상자로 실수 방지
- 삭제 후 자동 목록 새로고침
- 성공/실패 알림 표시

**물주기 일정 삭제**:
```javascript
const handleDeleteWatering = async (wateringId) => {
  Alert.alert(
    '삭제 확인',
    '이 물주기 일정을 삭제하시겠습니까?',
    [
      { text: '취소', style: 'cancel' },
      {
        text: '삭제',
        style: 'destructive',
        onPress: async () => {
          try {
            await deleteWateringSchedule(wateringId);
            Alert.alert('성공', '물주기 일정이 삭제되었습니다.');
            await loadAllData();
          } catch (error) {
            Alert.alert('오류', '삭제에 실패했습니다.');
          }
        },
      },
    ]
  );
};
```

**일기 삭제**:
```javascript
const handleDeleteDiary = async (diaryId) => {
  Alert.alert(
    '삭제 확인',
    '이 일기를 삭제하시겠습니까?',
    [
      { text: '취소', style: 'cancel' },
      {
        text: '삭제',
        style: 'destructive',
        onPress: async () => {
          try {
            await deleteDiary(diaryId);
            Alert.alert('성공', '일기가 삭제되었습니다.');
            await loadAllData();
          } catch (error) {
            Alert.alert('오류', '삭제에 실패했습니다.');
          }
        },
      },
    ]
  );
};
```

---

## 📦 컴포넌트 분석

### Calendar.jsx 구조
> 📍 경로: `components/myFarm/Calendar.jsx`

#### State 관리
```javascript
const [selectedDate, setSelectedDate] = useState('');      // 선택된 날짜
const [markedDates, setMarkedDates] = useState({});        // 마킹된 날짜들
const [events, setEvents] = useState([]);                  // 모든 일정
const [modalVisible, setModalVisible] = useState(false);   // 물주기 모달
const [diaryModalVisible, setDiaryModalVisible] = useState(false); // 일기 모달
const [loading, setLoading] = useState(true);              // 로딩 상태

const [wateringData, setWateringData] = useState({        // 물주기 입력 폼
  plantName: '',
  cycle: '7',
  count: '4',
});

const [diaryData, setDiaryData] = useState({              // 일기 입력 폼
  title: '',
  content: '',
  weather: '맑음',
});

const memId = 'user1'; // TODO: 로그인 연동
```

#### 핵심 함수들

**1. loadAllData() - 전체 데이터 로드**
```javascript
const loadAllData = async () => {
  try {
    setLoading(true);
    await Promise.all([
      loadWateringSchedules(),
      loadDiaries()
    ]);
  } catch (error) {
    console.error('데이터 로드 실패:', error);
    Alert.alert('오류', '데이터를 불러오는데 실패했습니다.');
  } finally {
    setLoading(false);
  }
};
```

**2. loadWateringSchedules() - 물주기 일정 로드**
```javascript
const loadWateringSchedules = async () => {
  try {
    const waterings = await fetchWateringSchedules(memId);
    const wateringEvents = (waterings ?? []).map((w) => ({
      id: w.wateringId,
      type: 'watering',
      date: w.wateringDate,        // YYYY-MM-DD
      plantName: w.plantName,
      cycle: w.cycleDay,
    }));
    
    updateEventsAndMarkers(wateringEvents, 'watering');
  } catch (error) {
    console.error('물주기 일정 로드 실패:', error);
  }
};
```

**3. loadDiaries() - 일기 로드**
```javascript
const loadDiaries = async () => {
  try {
    const diaries = await fetchDiaries(memId);
    const diaryEvents = (diaries ?? []).map((d) => ({
      id: d.diaryId,
      type: 'diary',
      date: d.diaryDate,           // YYYY-MM-DD
      title: d.diaryTitle,
      content: d.diaryContent,
      weather: d.weather ?? '맑음',
    }));
    
    updateEventsAndMarkers(diaryEvents, 'diary');
  } catch (error) {
    console.error('일기 로드 실패:', error);
  }
};
```

**4. updateEventsAndMarkers() - 이벤트 및 마커 업데이트**
```javascript
const updateEventsAndMarkers = (newEvents, type) => {
  // 기존 이벤트에서 해당 타입만 제거 후 새 이벤트 추가
  setEvents((prev) => {
    const filtered = prev.filter((e) => e.type !== type);
    return [...filtered, ...newEvents];
  });
  
  // 마커 업데이트
  const newMarked = {};
  newEvents.forEach((event) => {
    newMarked[event.date] = {
      ...(markedDates[event.date] ?? {}),
      marked: true,
      dotColor: type === 'watering' ? COLORS.primary : '#FFD700',
    };
  });
  
  setMarkedDates((prev) => ({ ...prev, ...newMarked }));
};
```

**5. onDayPress() - 날짜 선택**
```javascript
const onDayPress = (day) => {
  setSelectedDate(day.dateString); // YYYY-MM-DD
};
```

**6. addWateringSchedule() - 물주기 일정 추가**
```javascript
const addWateringSchedule = async () => {
  if (!wateringData.plantName) {
    Alert.alert('알림', '식물 이름을 입력해주세요.');
    return;
  }
  
  try {
    const cycle = parseInt(wateringData.cycle, 10);
    const count = parseInt(wateringData.count, 10);
    const startDate = new Date(selectedDate);
    
    // 주기별 반복 등록
    for (let i = 0; i < count; i++) {
      const eventDate = new Date(startDate);
      eventDate.setDate(startDate.getDate() + i * cycle);
      const dateString = eventDate.toISOString().split('T')[0];
      
      await apiAddWatering(memId, {
        plantName: wateringData.plantName,
        date: dateString,
        cycle: cycle,
      });
    }
    
    await loadWateringSchedules();
    setModalVisible(false);
    setWateringData({ plantName: '', cycle: '7', count: '4' });
    Alert.alert('성공', '물주기 일정이 추가되었습니다.');
  } catch (error) {
    Alert.alert('오류', '물주기 일정 추가에 실패했습니다.');
  }
};
```

**7. addDiary() - 일기 작성**
```javascript
const addDiary = async () => {
  if (!diaryData.title || !diaryData.content) {
    Alert.alert('알림', '제목과 내용을 입력해주세요.');
    return;
  }
  
  try {
    await apiAddDiary(memId, {
      title: diaryData.title,
      content: diaryData.content,
      weather: diaryData.weather,
      date: selectedDate,
    });
    
    await loadDiaries();
    setDiaryModalVisible(false);
    setDiaryData({ title: '', content: '', weather: '맑음' });
    Alert.alert('성공', '일기가 작성되었습니다.');
  } catch (error) {
    Alert.alert('오류', '일기 작성에 실패했습니다.');
  }
};
```

#### UI 구성
```
┌───────────────────────────────────────┐
│  📅 농사 캘린더                        │
│  물주기와 일기를 기록하세요             │
├───────────────────────────────────────┤
│  ┌─────────────────────────────────┐ │
│  │    2025년 10월                  │ │
│  │  일 월 화 수 목 금 토           │ │
│  │      1  2  3  4  5  6           │ │
│  │  7  8  9 10 11 12 13           │ │
│  │ 14 15 16 17 18 19 20           │ │
│  │ 21 22 23 24 25 26 27           │ │
│  │ 28 29•30 31                    │ │ 
│  │         ↑                       │ │
│  │     선택된 날짜                  │ │
│  └─────────────────────────────────┘ │
├───────────────────────────────────────┤
│  📅 2025-10-29                        │
│  ┌─────────────┬─────────────┐       │
│  │ 💧 물주기   │ 📝 일기쓰기 │       │
│  └─────────────┴─────────────┘       │
├───────────────────────────────────────┤
│  이날의 일정                           │
│  ┌─────────────────────────────┐     │
│  │ 💧 물주기          [🗑️]     │     │
│  │ 토마토                       │     │
│  │ 주기: 3일                    │     │
│  └─────────────────────────────┘     │
│  ┌─────────────────────────────┐     │
│  │ 📝 일기             [🗑️]     │     │
│  │ 토마토 첫 수확               │     │
│  │ 날씨: ☀️ 맑음               │     │
│  └─────────────────────────────┘     │
└───────────────────────────────────────┘
```

#### 캘린더 커스터마이징
```javascript
<RNCalendar
  markingType="custom"
  onDayPress={onDayPress}
  markedDates={{
    ...markedDates,
    ...(selectedDate
      ? {
          [selectedDate]: {
            ...(markedDates[selectedDate] ?? {}),
            selected: true,
            selectedColor: COLORS.primary,
          },
        }
      : {}),
  }}
  theme={{
    selectedDayBackgroundColor: COLORS.primary,
    todayTextColor: COLORS.primary,
    dotColor: COLORS.primary,
    arrowColor: COLORS.primary,
    monthTextColor: COLORS.text,
    textMonthFontSize: 18,
    textMonthFontWeight: 'bold',
  }}
  dayComponent={({ date, state, marking }) => {
    // 커스텀 날짜 렌더링
    const weekday = new Date(date.dateString).getDay();
    const isSunday = weekday === 0;
    const isSaturday = weekday === 6;
    
    let textColor = '#2d4150';
    if (state === 'disabled') textColor = '#d9e1e8';
    else if (state === 'today') textColor = COLORS.primary;
    else if (marking?.textColor) textColor = marking.textColor; // 공휴일
    else if (isSunday) textColor = '#FF6B6B';
    else if (isSaturday) textColor = '#4285F4';
    
    return (
      <TouchableOpacity onPress={() => onDayPress(date)}>
        {marking?.marked && (
          <View style={styles.dot} />
        )}
        <Text style={{ color: textColor }}>{date.day}</Text>
      </TouchableOpacity>
    );
  }}
/>
```

---

## 🔌 API 서비스

### calendarService.js
> 📍 경로: `services/calendarService.js`

#### API 엔드포인트
```javascript
const API_BASE_URL = 'http://192.168.30.107:8080';
// 또는 'http://192.168.30.97:8080'
```

#### 1. addWateringSchedule() - 물주기 일정 추가
```javascript
export const addWateringSchedule = async (memId, wateringData) => {
  try {
    const response = await fetch(`${API_BASE_URL}/watering`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        memId,
        plantName: wateringData.plantName,
        wateringDate: wateringData.date,
        cycleDay: wateringData.cycle,
      }),
    });
    
    const text = await response.text();
    
    if (!response.ok) {
      // 에러 메시지 커스터마이징
      let errorMsg = '물주기 일정 추가 실패';
      
      if (text.includes('foreign key constraint fails')) {
        errorMsg = '⚠️ 로그인이 필요하거나 사용자 정보가 유효하지 않습니다.';
      } else if (text.includes('Duplicate entry')) {
        errorMsg = '⚠️ 이미 같은 일정이 존재합니다.';
      } else if (response.status === 409) {
        errorMsg = '⚠️ 데이터 충돌이 발생했습니다.';
      } else if (response.status === 400) {
        errorMsg = '⚠️ 입력 데이터가 올바르지 않습니다.';
      }
      
      throw new Error(errorMsg);
    }
    
    // JSON 파싱 시도, 실패하면 텍스트 그대로 반환
    try {
      return JSON.parse(text);
    } catch (parseError) {
      return { success: true, message: text };
    }
  } catch (error) {
    throw error;
  }
};
```

**요청 예시**:
```json
POST /watering
{
  "memId": "user1",
  "plantName": "토마토",
  "wateringDate": "2025-10-29",
  "cycleDay": 3
}
```

**응답 예시 (성공)**:
```json
{
  "success": true,
  "wateringId": 123,
  "message": "물주기 일정이 추가되었습니다."
}
```

**응답 예시 (실패 - 외래키 오류)**:
```
⚠️ 로그인이 필요하거나 사용자 정보가 유효하지 않습니다.
```

#### 2. fetchWateringSchedules() - 물주기 일정 조회
```javascript
export const fetchWateringSchedules = async (memId) => {
  const response = await fetch(`${API_BASE_URL}/watering?memId=${memId}`);
  if (!response.ok) throw new Error('물주기 일정 조회 실패');
  return await response.json();
};
```

**요청 예시**:
```
GET /watering?memId=user1
```

**응답 예시**:
```json
[
  {
    "wateringId": 123,
    "memId": "user1",
    "plantName": "토마토",
    "wateringDate": "2025-10-29",
    "cycleDay": 3,
    "createdAt": "2025-10-25T10:30:00"
  },
  {
    "wateringId": 124,
    "memId": "user1",
    "plantName": "상추",
    "wateringDate": "2025-10-30",
    "cycleDay": 7,
    "createdAt": "2025-10-25T11:00:00"
  }
]
```

#### 3. deleteWateringSchedule() - 물주기 일정 삭제
```javascript
export const deleteWateringSchedule = async (wateringId) => {
  const response = await fetch(`${API_BASE_URL}/watering/${wateringId}`, {
    method: 'DELETE',
  });
  
  const text = await response.text();
  
  if (!response.ok) throw new Error('물주기 일정 삭제 실패');
  
  try {
    return JSON.parse(text);
  } catch (parseError) {
    return { success: true, message: text };
  }
};
```

**요청 예시**:
```
DELETE /watering/123
```

**응답 예시**:
```json
{
  "success": true,
  "message": "물주기 일정이 삭제되었습니다."
}
```

#### 4. addDiary() - 일기 작성
```javascript
export const addDiary = async (memId, diaryData) => {
  try {
    const response = await fetch(`${API_BASE_URL}/diaries`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        memId,
        diaryTitle: diaryData.title,
        diaryContent: `날씨: ${diaryData.weather}\n\n${diaryData.content}`,
        diaryDate: diaryData.date,
      }),
    });
    
    const text = await response.text();
    
    if (!response.ok) {
      let errorMsg = '일기 작성 실패';
      
      if (text.includes('foreign key constraint fails')) {
        errorMsg = '⚠️ 로그인이 필요하거나 사용자 정보가 유효하지 않습니다.';
      } else if (text.includes('Duplicate entry')) {
        errorMsg = '⚠️ 이미 같은 날짜에 일기가 존재합니다.';
      } else if (response.status === 409) {
        errorMsg = '⚠️ 데이터 충돌이 발생했습니다.';
      } else if (response.status === 400) {
        errorMsg = '⚠️ 입력 데이터가 올바르지 않습니다.';
      }
      
      throw new Error(errorMsg);
    }
    
    try {
      return JSON.parse(text);
    } catch (parseError) {
      return { success: true, message: text };
    }
  } catch (error) {
    throw error;
  }
};
```

**요청 예시**:
```json
POST /diaries
{
  "memId": "user1",
  "diaryTitle": "토마토 첫 수확",
  "diaryContent": "날씨: 맑음\n\n오늘 드디어 첫 토마토를 수확했다!",
  "diaryDate": "2025-10-29"
}
```

**응답 예시**:
```json
{
  "success": true,
  "diaryId": 456,
  "message": "일기가 작성되었습니다."
}
```

#### 5. fetchDiaries() - 일기 조회
```javascript
export const fetchDiaries = async (memId) => {
  const response = await fetch(`${API_BASE_URL}/diaries?memId=${memId}`);
  if (!response.ok) throw new Error('일기 조회 실패');
  return await response.json();
};
```

**요청 예시**:
```
GET /diaries?memId=user1
```

**응답 예시**:
```json
[
  {
    "diaryId": 456,
    "memId": "user1",
    "diaryTitle": "토마토 첫 수확",
    "diaryContent": "날씨: 맑음\n\n오늘 드디어 첫 토마토를 수확했다!",
    "diaryDate": "2025-10-29",
    "weather": "맑음",
    "createdAt": "2025-10-29T15:30:00"
  }
]
```

#### 6. deleteDiary() - 일기 삭제
```javascript
export const deleteDiary = async (diaryId) => {
  const response = await fetch(`${API_BASE_URL}/diaries/${diaryId}`, {
    method: 'DELETE',
  });
  
  const text = await response.text();
  
  if (!response.ok) throw new Error('일기 삭제 실패');
  
  try {
    return JSON.parse(text);
  } catch (parseError) {
    return { success: true, message: text };
  }
};
```

**요청 예시**:
```
DELETE /diaries/456
```

**응답 예시**:
```json
{
  "success": true,
  "message": "일기가 삭제되었습니다."
}
```

---

## 🔄 데이터 흐름

### 물주기 일정 등록 흐름
```
사용자 액션
    │
    ▼
1. 날짜 선택 (onDayPress)
    │
    ▼
2. "💧 물주기" 버튼 클릭
    │
    ▼
3. 모달 표시 (setModalVisible(true))
    │
    ▼
4. 식물 이름, 주기, 횟수 입력
    │
    ▼
5. "추가" 버튼 클릭 (addWateringSchedule)
    │
    ├─→ for 루프로 여러 일정 생성
    │   │
    │   ├─→ 날짜 계산 (startDate + i * cycle)
    │   │
    │   └─→ apiAddWatering 호출
    │       │
    │       └─→ POST /watering
    │
    ▼
6. loadWateringSchedules() 호출
    │
    ├─→ fetchWateringSchedules(memId)
    │   │
    │   └─→ GET /watering?memId=user1
    │
    ▼
7. updateEventsAndMarkers()
    │
    ├─→ setEvents (이벤트 배열 업데이트)
    │
    └─→ setMarkedDates (마커 업데이트)
    │
    ▼
8. 캘린더 재렌더링
    │
    └─→ 날짜에 파란색 점 표시 💧
```

### 일기 작성 흐름
```
사용자 액션
    │
    ▼
1. 날짜 선택 (onDayPress)
    │
    ▼
2. "📝 일기쓰기" 버튼 클릭
    │
    ▼
3. 모달 표시 (setDiaryModalVisible(true))
    │
    ▼
4. 제목, 내용, 날씨 입력
    │
    ▼
5. "저장" 버튼 클릭 (addDiary)
    │
    └─→ apiAddDiary 호출
        │
        └─→ POST /diaries
    │
    ▼
6. loadDiaries() 호출
    │
    ├─→ fetchDiaries(memId)
    │   │
    │   └─→ GET /diaries?memId=user1
    │
    ▼
7. updateEventsAndMarkers()
    │
    ├─→ setEvents (이벤트 배열 업데이트)
    │
    └─→ setMarkedDates (마커 업데이트)
    │
    ▼
8. 캘린더 재렌더링
    │
    └─→ 날짜에 노란색 점 표시 📝
```

### 삭제 흐름
```
사용자 액션
    │
    ▼
1. 일정 카드의 🗑️ 버튼 클릭
    │
    ▼
2. Alert.alert 확인 대화상자 표시
    │
    ├─→ "취소" 클릭 → 종료
    │
    └─→ "삭제" 클릭
        │
        ▼
3. API 호출
    │
    ├─→ 물주기: deleteWateringSchedule(wateringId)
    │   │
    │   └─→ DELETE /watering/{id}
    │
    └─→ 일기: deleteDiary(diaryId)
        │
        └─→ DELETE /diaries/{id}
    │
    ▼
4. loadAllData() 호출
    │
    ├─→ loadWateringSchedules()
    │
    └─→ loadDiaries()
    │
    ▼
5. 캘린더 재렌더링
    │
    └─→ 삭제된 일정의 점 제거
```

---

## 🛠 작업 히스토리

### Phase 1: 캘린더 기본 구조 구현 ✅
**작업 내용**:
- `react-native-calendars` 라이브러리 설치
- 기본 캘린더 UI 구현
- 날짜 선택 기능

**코드**:
```javascript
import { Calendar } from 'react-native-calendars';

<Calendar
  onDayPress={(day) => {
    setSelectedDate(day.dateString);
  }}
  markedDates={{
    [selectedDate]: { selected: true, selectedColor: '#00adf5' }
  }}
/>
```

---

### Phase 2: 물주기 일정 기능 구현 ✅
**작업 내용**:
- 물주기 일정 모달 UI
- 반복 일정 생성 로직
- API 연동

**주요 기능**:
```javascript
// 주기별 반복 일정 생성
for (let i = 0; i < count; i++) {
  const eventDate = new Date(startDate);
  eventDate.setDate(startDate.getDate() + i * cycle);
  const dateString = eventDate.toISOString().split('T')[0];
  
  await apiAddWatering(memId, {
    plantName: wateringData.plantName,
    date: dateString,
    cycle: cycle,
  });
}
```

---

### Phase 3: 일기 작성 기능 구현 ✅
**작업 내용**:
- 일기 작성 모달 UI
- 날씨 선택 기능
- API 연동

**날씨 옵션**:
```javascript
const weatherOptions = ['맑음', '흐림', '비', '폭우', '눈'];
```

---

### Phase 4: 공휴일 표시 기능 ✅
**작업 내용**:
- `date-holidays` 라이브러리 설치
- 한국 공휴일 로드
- 공휴일 스타일 커스터마이징

**특징**:
- 빨간색 배경 + 빨간색 텍스트
- 공휴일 점 표시
- ESM/CJS 호환 처리

---

### Phase 5: JSON Parse 에러 처리 ✅
**문제**: 서버가 성공 시 JSON이 아닌 텍스트 응답 반환

**원인**:
```javascript
// 서버 응답
"일기가 작성되었습니다."  // ← JSON이 아님!
```

**해결**:
```javascript
const text = await response.text();

if (!response.ok) {
  throw new Error(`작성 실패: ${text}`);
}

// JSON 파싱 시도, 실패하면 텍스트 그대로 반환
try {
  return JSON.parse(text);
} catch (parseError) {
  return { success: true, message: text };
}
```

---

### Phase 6: 외래키 에러 처리 ✅
**문제**: `memId='user1'`이 member 테이블에 없어서 외래키 제약 위반

**해결**: 사용자 친화적 에러 메시지
```javascript
if (text.includes('foreign key constraint fails')) {
  errorMsg = '⚠️ 로그인이 필요하거나 사용자 정보가 유효하지 않습니다.';
}
```

---

### Phase 7: 삭제 기능 추가 ✅
**작업 내용**:
- 삭제 버튼 UI 추가 (🗑️)
- 확인 대화상자 추가
- 삭제 API 연동
- 삭제 후 자동 새로고침

**UI**:
```jsx
<TouchableOpacity
  style={styles.deleteButton}
  onPress={() => handleDeleteWatering(event.id)}>
  <Text style={styles.deleteButtonText}>🗑️</Text>
</TouchableOpacity>
```

---

### Phase 8: Import 오류 수정 ✅
**문제**: 삭제 기능 구현 후 import 문에서 함수가 누락됨

**해결**:
```javascript
import {
  addDiary as apiAddDiary,
  addWateringSchedule as apiAddWatering,
  deleteDiary,                    // ✅ 추가
  deleteWateringSchedule,         // ✅ 추가
  fetchDiaries,
  fetchWateringSchedules
} from '../../services/calendarService';
```

---

## 🔥 트러블슈팅

### 문제 1: 캘린더 날짜 색상이 올바르지 않음

**증상**:
- 일요일이 빨간색이 아님
- 토요일이 파란색이 아님

**원인**:
- `date.day` (숫자)로 요일 계산 → 잘못된 결과
- `date.dateString` (YYYY-MM-DD)로 계산해야 정확

**해결**:
```javascript
// ❌ 잘못된 방법
const weekday = date.day % 7; // 날짜로 요일 계산 불가

// ✅ 올바른 방법
const weekday = new Date(date.dateString).getDay(); // 0=일, 6=토
```

---

### 문제 2: 공휴일 로드 실패

**증상**:
- 앱이 크래시됨
- "Cannot read property 'date' of undefined" 오류

**원인**:
- `date-holidays` 라이브러리의 ESM/CJS 호환 문제
- `holiday.date`가 문자열/Date 타입 혼용

**해결**:
```javascript
// ESM/CJS 호환 import
import HolidaysLib from 'date-holidays';
const Holidays = HolidaysLib.default ?? HolidaysLib;

// 날짜 안전 처리
const d = holiday?.date instanceof Date
  ? holiday.date
  : new Date(String(holiday?.date ?? '').split(' ')[0] || '');

if (!isNaN(d)) {
  const dateString = d.toISOString().slice(0, 10);
  // ...
}
```

---

### 문제 3: 물주기 일정 중복 등록

**증상**:
- 같은 식물, 같은 날짜에 여러 일정 등록됨

**원인**:
- DB에 UNIQUE 제약 조건 없음
- 프론트엔드에서 중복 검사 안 함

**해결**:

1. **백엔드 (추천)**:
```sql
ALTER TABLE watering 
ADD UNIQUE KEY unique_watering (MEM_ID, PLANT_NAME, WATERING_DATE);
```

2. **프론트엔드**:
```javascript
const addWateringSchedule = async () => {
  // 기존 일정 확인
  const existingEvents = events.filter(
    e => e.type === 'watering' && 
         e.plantName === wateringData.plantName &&
         e.date === selectedDate
  );
  
  if (existingEvents.length > 0) {
    Alert.alert('알림', '이미 같은 일정이 존재합니다.');
    return;
  }
  
  // 일정 추가
  // ...
};
```

---

### 문제 4: 일기 날짜가 선택한 날짜와 다름

**증상**:
- 10월 29일을 선택했는데 10월 28일로 저장됨

**원인**:
- 타임존 문제
- `new Date()`는 로컬 시간, `toISOString()`은 UTC 시간

**해결**:
```javascript
// ❌ 잘못된 방법
const dateString = new Date(selectedDate).toISOString().split('T')[0];
// UTC 변환으로 하루 차이 발생 가능

// ✅ 올바른 방법
const dateString = selectedDate; // 이미 YYYY-MM-DD 형식
```

---

### 문제 5: 삭제 후 캘린더가 업데이트 안 됨

**증상**:
- 일정을 삭제했는데 점이 사라지지 않음

**원인**:
- `loadAllData()` 호출 안 함
- 또는 `updateEventsAndMarkers()` 로직 오류

**해결**:
```javascript
const handleDeleteWatering = async (wateringId) => {
  // ...
  try {
    await deleteWateringSchedule(wateringId);
    await loadAllData(); // ✅ 반드시 호출
    Alert.alert('성공', '삭제되었습니다.');
  } catch (error) {
    Alert.alert('오류', '삭제 실패');
  }
};
```

---

## 🚀 향후 개선사항

### 1. 일정 수정 기능
**현재**: 생성과 삭제만 가능

**개선**:
- 일정 카드 클릭 → 수정 모달
- 식물 이름, 주기 변경 가능
- 일기 제목, 내용, 날씨 수정 가능

**구현 예시**:
```javascript
const [editingEvent, setEditingEvent] = useState(null);

const handleEditWatering = (event) => {
  setEditingEvent(event);
  setWateringData({
    plantName: event.plantName,
    cycle: event.cycle,
    count: '1',
  });
  setModalVisible(true);
};

const updateWateringSchedule = async () => {
  await fetch(`${API_BASE_URL}/watering/${editingEvent.id}`, {
    method: 'PUT',
    body: JSON.stringify(wateringData),
  });
  
  await loadAllData();
};
```

---

### 2. 일기 상세보기
**현재**: 일기 내용이 잘림

**개선**:
- 일기 카드 클릭 → 전체 내용 모달
- 사진 첨부 기능
- 마크다운 지원

**UI 예시**:
```jsx
<Modal visible={detailModalVisible}>
  <ScrollView>
    <Text style={styles.title}>{diary.title}</Text>
    <Text style={styles.date}>{diary.date}</Text>
    <Text style={styles.weather}>날씨: {diary.weather}</Text>
    <Text style={styles.content}>{diary.content}</Text>
    {diary.photos?.map(photo => (
      <Image key={photo.id} source={{ uri: photo.url }} />
    ))}
  </ScrollView>
</Modal>
```

---

### 3. 알림 기능
**목표**:
- 물주기 일정 당일 아침 알림
- 물주기 1일 전 사전 알림
- 일기 미작성 시 저녁 알림

**구현 방안**:
```javascript
import * as Notifications from 'expo-notifications';

const scheduleWateringNotification = async (wateringDate, plantName) => {
  await Notifications.scheduleNotificationAsync({
    content: {
      title: '💧 물주기 알림',
      body: `오늘은 ${plantName}에게 물을 줄 날입니다!`,
    },
    trigger: {
      date: new Date(wateringDate + 'T09:00:00'),
    },
  });
};
```

---

### 4. 통계 및 분석
**목표**:
- 월별 물주기 횟수 차트
- 식물별 물주기 빈도
- 일기 작성 통계
- 날씨별 성장 기록

**라이브러리**:
```bash
npm install react-native-chart-kit
```

**구현 예시**:
```jsx
import { BarChart } from 'react-native-chart-kit';

<BarChart
  data={{
    labels: ['토마토', '상추', '고추', '오이'],
    datasets: [{
      data: [12, 8, 15, 10] // 월별 물주기 횟수
    }]
  }}
  width={screenWidth}
  height={220}
  chartConfig={{
    backgroundColor: '#ffffff',
    decimalPlaces: 0,
  }}
/>
```

---

### 5. 공유 기능
**목표**:
- 일기 SNS 공유
- 농사 기록 PDF 내보내기
- 친구와 일정 공유

**구현**:
```javascript
import * as Sharing from 'expo-sharing';
import * as Print from 'expo-print';

const exportDiaryPDF = async () => {
  const html = `
    <html>
      <body>
        <h1>${diary.title}</h1>
        <p>날짜: ${diary.date}</p>
        <p>날씨: ${diary.weather}</p>
        <p>${diary.content}</p>
      </body>
    </html>
  `;
  
  const { uri } = await Print.printToFileAsync({ html });
  await Sharing.shareAsync(uri);
};
```

---

### 6. 오프라인 지원
**목표**:
- 네트워크 없이도 일정 조회
- 오프라인 일기 작성 → 온라인 시 동기화

**구현**:
```javascript
import AsyncStorage from '@react-native-async-storage/async-storage';

const loadDiariesWithCache = async () => {
  try {
    // 네트워크 시도
    const diaries = await fetchDiaries(memId);
    await AsyncStorage.setItem('diaries', JSON.stringify(diaries));
    return diaries;
  } catch (error) {
    // 네트워크 실패 시 캐시 사용
    const cached = await AsyncStorage.getItem('diaries');
    return cached ? JSON.parse(cached) : [];
  }
};
```

---

## 📚 참고 자료

### 라이브러리 문서
- react-native-calendars: https://github.com/wix/react-native-calendars
- date-holidays: https://github.com/commenthol/date-holidays

### API 문서
- Spring Boot REST API: http://192.168.30.107:8080/swagger-ui.html

### 관련 파일
```
📁 components/myFarm/
  └── Calendar.jsx              # 캘린더 메인 화면

📁 services/
  └── calendarService.js        # 캘린더 API 통신

📁 constants/
  └── myFarmConstant.js         # 색상/스타일 상수
```

### 색상 가이드
```javascript
export const COLORS = {
  primary: '#4CAF50',      // 초록색 (물주기)
  secondary: '#FFD700',    // 노란색 (일기)
  holiday: '#FF6B6B',      // 빨간색 (공휴일)
  success: '#4CAF50',      // 성공
  warning: '#FF9800',      // 경고
  error: '#F44336',        // 오류
  text: '#333333',         // 기본 텍스트
  textLight: '#999999',    // 연한 텍스트
};
```

---

## ✅ 체크리스트

### 개발 완료 항목
- [x] 캘린더 UI 렌더링
- [x] 날짜 선택 기능
- [x] 물주기 일정 등록 (반복 지원)
- [x] 일기 작성 (날씨 포함)
- [x] 공휴일 자동 표시
- [x] 일정 시각화 (점 표시)
- [x] 일정/일기 삭제 기능
- [x] JSON Parse 에러 처리
- [x] 외래키 에러 처리
- [x] 확인 대화상자

### 진행 중 항목
- [ ] 사용자별 memId 연동
- [ ] 일정 수정 기능

### 미착수 항목
- [ ] 일기 상세보기
- [ ] 알림 기능
- [ ] 통계 및 분석
- [ ] 공유 기능
- [ ] 오프라인 지원
- [ ] 사진 첨부 기능

---

**작성일**: 2025년 10월 29일  
**작성자**: GitHub Copilot  
**버전**: 1.0.0  
**최종 수정**: 삭제 기능 완료 및 import 오류 수정
